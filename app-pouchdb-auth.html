<link rel="import" href="pouchdb.authentication.html">
<link rel="import" href="app-pouchdb-database-behavior.html">

<dom-module id="app-pouchdb-auth">
<script>
  (function() {
    'use-strict';

    var IS_LOGGING_OUT = 'app-pouchdb-auth:logging-out';
    var AUTH_RESPONSE_EVENT = 'app-pouchdb-auth-response';
    var AUTH_RESPONSE_ERROR = 'app-pouchdb-auth-error';
    var COUCH_DB_UNDEFINED_ERROR = 'No PouchDB instance configured.';
    var MAX_RETRY_INTERVAL = 60000;

    Polymer({
      is: 'app-pouchdb-auth',

      behaviors: [Polymer.AppPouchDBDatabaseBehavior],

      properties: {
        session: {
          type: Object,
          readOnly: true
        },

        isLoggedIn: {
          type: Boolean,
          computed: '__computeIsLoggedIn(session.userCtx.name)'
        },

        __logoutRetryInterval: {
          type: Number,
          value: 0
        }
      },

      observers: ['_dbChanged(db)'],

      _dbChanged: function() {
        if (!this.db) {
          return;
        }

        this.db.getSession().then(function(session) {
          this._setSession(session);

          if (window.localStorage.getItem(IS_LOGGING_OUT)) {
            this.logout();
          }
        }.bind(this));
      },

      login: function(username, password) {
        var source = 'login';
        var errorHandler = this.__createErrorHandler(source);

        if (!this.db) {
          return errorHandler(new Error(COUCH_DB_UNDEFINED_ERROR));
        }

        return this.db.login(username, password).then(function(loginResponse) {
          return this.db.getSession().then(function(session) {
            this._setSession(session);

            var finalResponse = {loginResponse, session};

            this.fire(AUTH_RESPONSE_EVENT,
                {source: source, response: finalResponse});

            return Promise.resolve(finalResponse);

          }.bind(this));

        }.bind(this)).catch(errorHandler);
      },

      logout: function() {
        var source = 'logout';
        var errorHandler = this.__createErrorHandler(source);

        if (!this.db) {
          return errorHandler(new Error(COUCH_DB_UNDEFINED_ERROR));
        }

        return this.db.logout().then(function(logoutResponse) {
          logoutResponse.online = true;
          this.__logoutRetryInterval = 0;

          try {
            window.localStorage.setItem(IS_LOGGING_OUT, false);
          } catch (error) {
            var errorHandler = this.__createErrorHandler(
              'logout writing to localStorage');

            errorHandler(error);
          }

          return this.db.getSession().then(function(session) {
            this._setSession(session);

            var finalResponse = {logoutResponse, session};

            this.fire(AUTH_RESPONSE_EVENT,
                {source: source, response: finalResponse});

            return Promise.resolve(finalResponse);

          }.bind(this));

        }.bind(this)).catch(function(error){
          if (error.status == 500) {
            return this.__retryLogout();
          } else {
            return errorHandler(error);
          }

        }.bind(this));
      },

      signup: function(username, password, options) {
        var source = 'signup';
        var errorHandler = this.__createErrorHandler(source);

        options = options || {};

        if (!this.db) {
          return errorHandler(new Error(COUCH_DB_UNDEFINED_ERROR));
        }

        return this.__promiseHandler(this.db.signup(username, password,
            options), source);

      },

      getUser: function(username) {
        var source = 'get user';
        var errorHandler = this.__createErrorHandler(source);

        if (!this.db) {
          return errorHandler(new Error(COUCH_DB_UNDEFINED_ERROR));
        }

        return this.__promiseHandler(this.db.getUser(username), source);

      },

      updateMetadata: function(options, username) {
        var source = 'update metadata';
        var errorHandler = this.__createErrorHandler(source);

        if (!this.db) {
          return errorHandler(new Error(COUCH_DB_UNDEFINED_ERROR));
        }

        if (!username) {
          username = this.session.userCtx.name;
        }

        return this.__promiseHandler(this.db.putUser(username, options), source);
      },

      updateUsername: function(newUsername, username) {
        var source = 'change username';
        var errorHandler = this.__createErrorHandler(source);

        if (!this.db) {
          return errorHandler(new Error(COUCH_DB_UNDEFINED_ERROR));
        }

        if (!username) {
          username = this.session.userCtx.name;
        }

        return this.__promiseHandler(this.db.changeUsername(username,
            newUsername), source);
      },

      updatePassword: function(newPassword, username) {
        var source = 'change password';
        var errorHandler = this.__createErrorHandler(source);

        if (!this.db) {
          return errorHandler(new Error(COUCH_DB_UNDEFINED_ERROR));
        }

        if (!username) {
          username = this.session.userCtx.name;
        }

        return this.__promiseHandler(this.db.changePassword(username,
            newPassword), source);

      },

      __computeIsLoggedIn: function(username) {
        return username ? true : false;
      },

      __retryLogout: function() {
        if (!this.__logoutRetryInterval) {
          this.set('session.userCtx.name', null);
          this.set('session.userCtx.roles', []);

          this.__logoutRetryInterval = 100;
          try {
            window.localStorage.setItem(IS_LOGGING_OUT, true);
          } catch (error) {
            var errorHandler = this.__createErrorHandler(
              'logout writing to localStorage');

            errorHandler(error);
          }

        } else {
          this.__logoutRetryInterval = Math.min(this.__logoutRetryInterval * 2,
              MAX_RETRY_INTERVAL);
        }

        this.async(this.logout, this.__logoutRetryInterval);

        return Promise.resolve({ok: true, online: false});
      },

      __createErrorHandler: function(errorSource) {
        return function(error) {
          this.fire(AUTH_RESPONSE_ERROR,
              {source: errorSource, error: error});

          console.error(error);
          return Promise.reject(error);
        }
      },

      __createResponseHandler: function(responseSource) {
        return function(response) {
          this.fire(AUTH_RESPONSE_EVENT,
              {source: responseSource ,response: response});

          return Promise.resolve(response);
        }.bind(this);
      },

      __promiseHandler: function(promise, source) {
        var responseHandler = this.__createResponseHandler(source);
        var errorHandler = this.__createErrorHandler(source);

        return promise.then(responseHandler).catch(errorHandler);
      }
    });
  })();
</script>
</dom-module>
