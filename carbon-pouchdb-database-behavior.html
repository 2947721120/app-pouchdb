<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="pouchdb.html">
<script>
  (function() {
    'use strict';

    Polymer.CarbonPouchDBDatabaseBehavior = {
      properties: {
        adapter: {
          type: String,
          value: null
        },

        dbName: {
          type: String
        },

        revsLimit: {
          type: Number,
          value: 0
        },

        db: {
          type: Object,
          computed: '__computeDb(dbName, adapter, revsLimit)',
          notify: true,
        },

        upsert: {
          type: Boolean,
          value: false
        },

        resolveConflict: {
          type: Function,
          value: null
        }
      },

      _put: function(path, value, doc) {
        if (this.upsert) {
          return this._upsert(path, value, doc);
        } else {
          return this._conflictAwareTransaction('put', doc);
        }
      },

      _post: function(doc) {
        if (this.upsert) {
          return this._upsert('data', doc, doc);
        } else {
          return this._conflictAwareTransaction('post', doc);
        }
      },

      _upsert: function(path, value, doc) {
        var lookup = doc._id != null ?
            this.db.get(doc._id) :
            Promise.reject({ status: 404 });

        this._log('Upsert', path, value, doc);
        return lookup.then(function(existingDoc) {
          // Update...
          this._log('Upsert -> update', path, value, doc);
          if (path === 'data') {
            value._rev = existingDoc._rev;
            value._id = existingDoc._id;
            doc = value;
          } else {
            this.set(path, value, {
              data: existingDoc
            });
            doc = existingDoc;
          }

          return this._conflictAwareTransaction('put', doc);
        }.bind(this)).catch(function(error) {
          if (error.status === 404) {
            // Insert...
            this._log('Upsert -> insert', path, value, doc);
            return this._conflictAwareTransaction('post', doc);
          }

          throw error;
        }.bind(this));
      },

      _conflictAwareTransaction: function(method, doc) {
        if (!method in this.db) {
          return Promise.reject('No such method:', method);
        }

        this._log('Conflict aware:', method, doc);
        return this.db[method](doc).catch(function(error) {
          var conflictResolver = null;
          if (error && error.status === 409) {
            this._log(this.id, 'Conflict for', method, doc._id, error._rev, error._conflicts);
            conflictResolver = this.resolveConflict;

            this.fire('carbon-pouchdb-conflict', {
              resolveConflict: function(_conflictResolver) {
                if (_conflictResolver) {
                  conflictResolver = _conflictResolver;
                }
              }.bind(this)
            });

            if (conflictResolver) {
              this._log(this.id, 'Attempting conflict resolution..', method, doc);
              return Promise.resolve(conflictResolver.call(this, this.db, method, doc, error));
            }
          }

          throw error;
        }.bind(this));
      },

      __computeDb: function(name, revsLimit, adapter) {
        if (this.db) {
          this.db.removeAllListeners();
        }

        if (!name) {
          return null;
        }

        var options = {
          auto_compaction: true
        };

        if (adapter) {
          options.adapter = adapter;
        }

        if (revsLimit) {
          options.revs_limit = revsLimit;
        }

        return new PouchDB(name, options);
      }
    };
  })();
</script>
